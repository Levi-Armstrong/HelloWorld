name: CMake Build Matrix

on: [push, pull_request]

env:
  CMAKE_VERSION: 3.16.2
  NINJA_VERSION: 1.9.0
  BUILD_TYPE: Release
  CCACHE_VERSION: 3.7.7

jobs:
  build:
    name: ${{ matrix.env.CI_NAME }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        env:
          - {CI_NAME: "Melodic Build",
             CI_ARTIFACT: "melidic.tar.xz",
#             CCACHE_DIR: "/github/home/.ccache",
             DOCKER_IMAGE: "lharmstrong/tesseract:melodic",
             OS_NAME: ubuntu,
             OS_CODE_NAME: bionic,
             ROS_DISTRO: melodic,
             ROS_REPO: main,
             BADGE: bionic}
          - {CI_NAME: "Kinetic Build",
             CI_ARTIFACT: "kinetic.tar.xz",
#             CCACHE_DIR: "/github/home/.ccache",
             DOCKER_IMAGE: "lharmstrong/tesseract:kinetic",
             OS_NAME: ubuntu,
             OS_CODE_NAME: xenial,
             ROS_DISTRO: kinetic,
             ROS_REPO: main,
             BADGE: xenial}

    steps:
    - uses: actions/checkout@v1

#    - name: Download ccache
#      id: ccache
#      shell: cmake -P {0}
#      run: |
#        set(ccache_url "https://github.com/ros-industrial-consortium/tesseract/ccache/releases/download/v$ENV{CCACHE_VERSION}/${{ runner.os }}.tar.xz")
#        file(DOWNLOAD "${ccache_url}" ./ccache.tar.xz SHOW_PROGRESS)
#        execute_process(COMMAND ${CMAKE_COMMAND} -E tar xvf ./ccache.tar.xz)
#    - name: Prepare ccache timestamp
#      id: ccache_cache_timestamp
#      shell: cmake -P {0}
#      run: |
#        string(TIMESTAMP current_date "%Y-%m-%d-%H;%M;%S" UTC)
#        message("::set-output name=timestamp::${current_date}")
#    - name: ccache cache files
#      uses: actions/cache@v1.1.0
#      with:
#        path: ~/.ccache
#        key: ${{ matrix.env.CI_NAME }}-ccache-${{ steps.ccache_cache_timestamp.outputs.timestamp }}
#        restore-keys: |
#          ${{ matrix.env.CI_NAME }}-ccache-

    - uses: 'ros-industrial/industrial_ci@master'
      env: ${{matrix.env}}

#    - name: Pack
#      working-directory: instdir
#      run: ${{ steps.cmake_and_ninja.outputs.cmake_dir }}/cmake -E tar cJfv ../${{ matrix.env.CI_ARTIFACT }} .

#    - name: Upload
#      uses: actions/upload-artifact@v1
#      with:
#        path: ./${{ matrix.env.CI_ARTIFACT }}
#        name: ${{ matrix.env.CI_ARTIFACT }}

